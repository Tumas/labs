#!/usr/bin/ruby
$: << File.join(File.dirname(__FILE__), "/../lib")

require 'yaml'
require 'learning_app'

class LearningSystemShoesScript < Shoes
  include LearningSystem

  TITLE = "Learning system"

  # pages
  url '/', :index
  url '/register', :register
  url '/user', :user
  url '/add_word', :add_word

  USERS_DB = File.join(File.dirname(__FILE__), '/../users.yaml')

  def index
    @@user = User.new("username", "password") 
    @@user_manager = UserHandler.new(YAML.load_file(USERS_DB))

    stack :margin_top => 10 do
      subtitle TITLE, :align => "center" 

      @content = stack :margin => 30 do
        @@username_field = edit_line :text => @@user.name, :width => 150
        @@password_field = edit_line :text => @@user.pass, :width => 150
      
        button("login") do
          @@user = User.new(@@username_field.text, @@password_field.text)
          begin
            @@user = @@user_manager.login(@@user)
            visit '/user'
          rescue 
            alert "Whoops! BadaBoom!"
          end
        end
        para("First time here? " ,
             link("Sign up", :click => "/register"))
      end
    end
  end

  def register
    stack :margin_top => 10 do
      subtitle TITLE, :align => "center" 

      stack :margin => 30 do
        @@username_field = edit_line :text => @@user.name, :width => 150
        @@password_field = edit_line :text => @@user.pass, :width => 150
        button("register me") do
          begin
            @@user_manager.register(User.new(@@username_field.text, @@password_field.text))

            # save state after registration
            File.open(USERS_DB, 'w') do |out|
              YAML.dump(@@user_manager.users, out)
            end

            alert "User #{@@username_field.text} was succesfully registered"
            visit "/user"
          rescue 
            alert "Whoops!"
          end
        end

        para("Naah.. I want to ",
          link("go back", :click => "/"))
      end
    end
  end

  def user
    flow :margin => 5 do
      @left = stack :width => 120 do
        para @@user.name, :margin_top => 5, :margin_left => 14, :size => 20
        para "Statistics: ", :stroke => red 
        para "Words:\t#{@@user.words.size}\n",
             "Tests:\t#{@@user.tests.size}\n",
             "Quizzes:\t0", 
               :margin_left => 20, :size => 8 
        para "Actions: ", :stroke => red 
        para(
          link("Add word\n", :click => '/add_word'),
          link("Add quiz\n", :click => '/add_test'),
          link("Take quiz\n", :click => '/take_quiz'),
            :margin_left => 20, :size => 8)
      end
      @right = stack :width => -120 do
        para(
          link(" Words ", :click => '/user', :margin_right => 10),
          link(" Quizzes ", :click => '/user', :margin_right => 10),
          link(" Tests ", :click => '/user', :margin_right => 10),
            :size => 12
        )
        # showing user's words
        words = []
        @@user.each_word do |w|
           words.push "#{words.size / 4}\t", link(w.value, :click => '/user', :size => 10, :margin => 0), "\t#{w.times_answered}", "\t#{w.times_guessed}\n"
        end
        para( words.each {|w| strong w }, :size => 10)
      end
    end
  end

  def add_word
    stack :margin => 30 do
        subtitle "Add a new word, #{@@user.name}"
        @value = edit_line :width => 400, :text => 'words value'
        @translation = edit_line :width => 400, :text => 'meaning or translation'
        @hint = edit_line :width => 400, :text => 'hint (not required)'
        button "add word" do
          #@hint.text = nil if @hind.text =~ /^hint \((.)*\)&/
          @@user.add_word(Word.new(@value.text, @translation.text, @hint.text))
          visit '/user'
        end
    end
  end
end

Shoes.app :width => 512, :title => 'FL Learning system'
